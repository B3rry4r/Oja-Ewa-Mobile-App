# Fastfile
opt_out_usage

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    setup_ci

    create_keychain(
      name: "signing_keychain",
      password: ENV['MATCH_KEYCHAIN_PASSWORD'],
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_filepath: './AuthKey.p8'
    )

    match(
      type: "appstore",
      keychain_name: "signing_keychain",
      keychain_password: ENV['MATCH_KEYCHAIN_PASSWORD'],
      readonly: true,
      app_identifier: "com.wawuafrica.ojaewa",
      git_url: ENV['MATCH_GIT_URL'],
      git_basic_authorization: Base64.strict_encode64("#{ENV['MATCH_GIT_TOKEN']}:x-oauth-basic"),
      storage_mode: "git",
      api_key: api_key,
      force_for_new_devices: true,
      clone_branch_directly: true
    )

    # AGGRESSIVE LOGGING
    UI.important("="*80)
    UI.important("PROFILE LOCATION DEBUGGING")
    UI.important("="*80)
    
    profile_name = Actions.lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]["com.wawuafrica.ojaewa"]
    UI.message("Profile name from match: #{profile_name}")
    
    # Check all possible profile locations
    UI.message("Checking profile locations:")
    sh("ls -la ~/Library/MobileDevice/Provisioning\\ Profiles/ || echo 'MobileDevice directory not found'")
    sh("ls -la ~/Library/Developer/Xcode/UserData/Provisioning\\ Profiles/ || echo 'UserData directory not found'")
    
    # List all .mobileprovision files
    UI.message("All .mobileprovision files on system:")
    sh("find ~ -name '*.mobileprovision' 2>/dev/null || echo 'No profiles found'")
    
    UI.important("="*80)

    update_project_team(
      path: "Runner.xcodeproj",
      teamid: ENV['APPLE_TEAM_ID']
    )

    increment_build_number(
      build_number: latest_testflight_build_number(
        api_key: api_key,
        app_identifier: "com.wawuafrica.ojaewa"
      ) + 1,
      xcodeproj: "Runner.xcodeproj"
    )

    Dir.chdir("..") do
      sh("flutter", "build", "ios", "--release", "--no-codesign")
    end

    require 'xcodeproj'
    project = Xcodeproj::Project.open("../Runner.xcodeproj")

    project.targets.each do |target|
      if target.name == "Runner"
        target.build_configurations.each do |config|
          if config.name == "Release"
            config.build_settings["CODE_SIGN_STYLE"] = "Manual"
            config.build_settings["PROVISIONING_PROFILE_SPECIFIER"] = profile_name
            config.build_settings["DEVELOPMENT_TEAM"] = ENV['APPLE_TEAM_ID']
            config.build_settings["CODE_SIGN_IDENTITY[sdk=iphoneos*]"] = "iPhone Distribution"
            
            # LOG WHAT WE SET
            UI.important("="*80)
            UI.important("XCODE PROJECT SETTINGS (Release)")
            UI.important("="*80)
            UI.message("CODE_SIGN_STYLE: #{config.build_settings['CODE_SIGN_STYLE']}")
            UI.message("PROVISIONING_PROFILE_SPECIFIER: #{config.build_settings['PROVISIONING_PROFILE_SPECIFIER']}")
            UI.message("DEVELOPMENT_TEAM: #{config.build_settings['DEVELOPMENT_TEAM']}")
            UI.message("CODE_SIGN_IDENTITY: #{config.build_settings['CODE_SIGN_IDENTITY[sdk=iphoneos*]']}")
            UI.important("="*80)
          end
        end
      end
    end

    project.save

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.wawuafrica.ojaewa" => profile_name
        },
        signingStyle: "manual",
        teamID: ENV['APPLE_TEAM_ID'],
        signingCertificate: "iPhone Distribution",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false
      },
      clean: true,
      verbose: true,
      xcargs: "-allowProvisioningUpdates",
      output_directory: "./build/ios/ipa/",
      silent: false
    )

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: false,
      skip_submission: false,
      distribute_external: false,
      notify_external_testers: false,
      changelog: "Automated build from GitHub Actions"
    )

    delete_keychain(name: "signing_keychain")
  end

  error do |lane, exception|
    delete_keychain(name: "signing_keychain") if File.exist?(File.expand_path("~/Library/Keychains/signing_keychain-db"))
    UI.message("Error occurred: #{exception.message}")
  end
end
